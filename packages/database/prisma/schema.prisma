generator client {
  provider = "prisma-client-js"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "sqlserver"
  url      = env("DATABASE_URL")
}

model User {
  id              String            @id @default(uuid())
  name            String
  email           String            @unique
  role            String            @default("user")
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt
  fullName        String?
  userRole        String?
  assignedCases   Case[]
  preBillAnalyses PreBillAnalysis[]
  queries         Query[]

  @@map("users")
}

model Query {
  id         String   @id @default(uuid())
  question   String
  answer     String?
  confidence Float?
  sources    String?
  status     String   @default("pending")
  context    String?
  userId     String
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  user       User     @relation(fields: [userId], references: [id])

  @@map("queries")
}

model Case {
  id                  String      @id @default(uuid())
  title               String
  description         String?
  status              String      @default("open")
  priority            String      @default("medium")
  assignedUserId      String?
  createdAt           DateTime    @default(now())
  updatedAt           DateTime    @updatedAt
  patientFhirId       String?
  encounterFhirId     String?
  medicalRecordNumber String?
  patientName         String?
  age                 Int?
  gender              String?
  admissionDate       DateTime?
  dischargeDate       DateTime?
  primaryDiagnosis    String?
  currentDRG          String?
  openDate            DateTime?
  closeDate           DateTime?
  facilityId          String?
  assignedUser        User?       @relation(fields: [assignedUserId], references: [id])
  denials             Denial[]
  encounters          Encounter[]

  @@map("cases")
}

model Patient {
  id            String        @id @default(uuid())
  name          String
  mrn           String        @unique
  dob           DateTime?
  gender        String?
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
  encounters    Encounter[]
  fhirResources FhirResource[]

  @@map("patients")
}

model Encounter {
  id              String            @id @default(uuid())
  patientId       String
  caseId          String?
  encounterId     String            @unique
  chiefComplaint  String?
  admissionDate   DateTime?
  dischargeDate   DateTime?
  status          String            @default("active")
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt
  diagnoses       Diagnosis[]
  case            Case?             @relation(fields: [caseId], references: [id])
  patient         Patient           @relation(fields: [patientId], references: [id])
  preBillAnalyses PreBillAnalysis[]
  procedures      Procedure[]
  fhirResources   FhirResource[]

  @@map("encounters")
}

model Diagnosis {
  id          String    @id @default(uuid())
  encounterId String
  icdCode     String
  description String
  isPrimary   Boolean   @default(false)
  encounter   Encounter @relation(fields: [encounterId], references: [id])

  @@index([icdCode])
  @@map("diagnoses")
}

model Procedure {
  id          String    @id @default(uuid())
  encounterId String
  cptCode     String
  description String
  encounter   Encounter @relation(fields: [encounterId], references: [id])

  @@index([cptCode])
  @@map("procedures")
}

model PreBillAnalysis {
  id                       String    @id @default(uuid())
  encounterId              String
  confidence               Float
  recommendations          String    @db.NVarChar(Max)
  riskFactors              String?   @db.NVarChar(Max)
  notes                    String?   @db.NVarChar(Max)
  status                   String    @default("pending")
  userId                   String?
  createdAt                DateTime  @default(now())
  updatedAt                DateTime  @updatedAt
  potentialFinancialImpact Float?
  description              String?   @db.NVarChar(Max)
  evidenceId               String?   @unique
  embedding                String?   @db.NVarChar(Max)
  encounter                Encounter @relation(fields: [encounterId], references: [id])
  user                     User?     @relation(fields: [userId], references: [id], onDelete: NoAction, onUpdate: NoAction)

  @@map("pre_bill_analyses")
}

model Denial {
  id                String    @id @default(uuid())
  caseId            String?
  denialReason      String
  amount            Float
  status            String    @default("pending")
  appealDate        DateTime?
  resolution        String?
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  denialReasonCode  String?
  deniedAmount      Float?
  appealLetterDraft String?
  claimFhirId       String?
  case              Case?     @relation(fields: [caseId], references: [id])

  @@map("denials")
}

model FhirResource {
  id           String   @id @default(uuid())
  resourceType String
  patientId    String?
  encounterId  String?
  json         String   @db.NVarChar(Max)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  patient      Patient?   @relation(fields: [patientId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  encounter    Encounter? @relation(fields: [encounterId], references: [id], onDelete: NoAction, onUpdate: NoAction)

  @@index([resourceType])
  @@index([patientId])
  @@index([encounterId])
  @@map("fhir_resources")
}

model Analytics {
  id           String   @id @default(uuid())
  metric       String
  value        Float
  dimension    String?
  timestamp    DateTime @default(now())
  caseId       String?
  userId       String?
  activityType String?
  description  String?

  @@map("analytics")
}

/// ---------- Lookup vocab (current snapshots only) ----------
model Icd10Cm {
  code     String   @id
  title    String?
  longDesc String?
  effFrom  DateTime
  effTo    DateTime?
  @@map("lkp_icd10cm")
  @@index([title])
}

model Icd10Pcs {
  code    String  @id
  title   String?
  effFrom DateTime
  effTo   DateTime?
  @@map("lkp_icd10pcs")
}

model MsDrg {
  drg      String   @id
  desc     String?
  rw       Decimal? @db.Decimal(9, 4)
  gmlos    Decimal? @db.Decimal(6, 2)
  amlos    Decimal? @db.Decimal(6, 2)
  transfer Boolean?
  effFrom  DateTime
  effTo    DateTime?
  @@map("lkp_msdrg")
  @@index([rw, gmlos, amlos])
}

model Hcpcs {
  code    String  @id
  short   String?
  long    String?
  status  String?
  effFrom DateTime
  effTo   DateTime?
  @@map("lkp_hcpcs")
  @@index([status])
}

model NcciPtp {
  id      String  @id @default(uuid())
  codeA   String
  codeB   String
  modInd  String
  effFrom DateTime
  effTo   DateTime?
  @@unique([codeA, codeB, effFrom])
  @@map("lkp_ncci_ptp")
  @@index([codeA, codeB])
}

model NcciMue {
  code    String
  effFrom DateTime
  mue     Int
  effTo   DateTime?
  @@id([code, effFrom])
  @@map("lkp_ncci_mue")
}

model Carc {
  code    String @id
  grp     String?
  desc    String?
  effFrom DateTime?
  effTo   DateTime?
  @@map("lkp_carc")
}

model Rarc {
  code    String @id
  desc    String?
  effFrom DateTime?
  effTo   DateTime?
  @@map("lkp_rarc")
}

/// ---------- Provider taxonomy (light) ----------
model NuccTaxonomy {
  code           String @id
  grouping       String?
  classification String?
  specialization String?
  display        String?
  @@map("lkp_nucc_taxonomy")
  @@index([grouping, classification, specialization])
}

/// Minimal NPI subset (tiny; weekly delta only if needed)
model NpiProvider {
  npi        String @id
  entityType String?
  name       String?
  orgName    String?
  taxonomy   String?
  state      String?
  postalCode String?
  @@map("lkp_npi_provider")
  @@index([taxonomy, state])
}

/// ---------- Denial/EOB working facts ----------
model EobLine {
  id           String   @id @default(uuid())
  claimId      String
  lineNum      Int
  hcpcs        String?
  units        Int?
  chargeAmt    Decimal? @db.Decimal(12, 2)
  paidAmt      Decimal? @db.Decimal(12, 2)
  drg          String?
  serviceFrom  DateTime?
  serviceTo    DateTime?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  adjudications EobAdjudication[]
  @@map("fact_eob_line")
  @@unique([claimId, lineNum])
  @@index([hcpcs, drg])
}

/// Physician Query Governance Models (initial scaffold)
/// Compliant physician query workflow separate from generic NLQ `Query`.
/// (Previous feature flag gating removed; always active.)
model QueryTemplate {
  id                  String   @id @default(uuid())
  code                String   @unique
  title               String
  bodyMarkup          String
  guidance            String?
  clinicalIndicators  String?   @db.NVarChar(Max) // was Json? (unsupported on SQL Server) serialized JSON text
  version             Int      @default(1)
  active              Boolean  @default(true)
  nonLeadingValidated Boolean @default(false)
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt
  physicianQueries    PhysicianQuery[]
}

// Enums converted to lookup strings due to SQL Server provider limitations (no native enum support)
// PhysicianQueryStatus values stored as string with constrained set enforced application-side
// (Optionally create separate lookup tables later.)
// Original enum values: DRAFT, SENT, RESPONDED, CLARIFICATION_REQUESTED, ESCALATED, CLOSED, WITHDRAWN, CANCELED

// PhysicianResponseType enum removed; store as string (AGREE, DISAGREE, PROVIDE_ADDITIONAL_INFO, DECLINE)

// PhysicianQueryEventType enum removed; store as string (CREATED, TEMPLATE_APPLIED, SENT, REMINDER_SENT, RESPONDED, CLARIFICATION_REQUESTED, ESCALATED, CLOSED, WITHDRAWN, STATUS_CHANGED, SLA_BREACH)

// EvidenceSourceType enum removed; store as string (NOTE, LAB_RESULT, IMAGING_REPORT, CLAIM, OTHER)

model PhysicianQuery {
  id                   String   @id @default(uuid())
  templateId           String
  template             QueryTemplate @relation(fields: [templateId], references: [id])
  templateVersion      Int
  templateSnapshot     String   @db.NVarChar(Max) // was Json
  caseId               String?
  encounterId          String?
  createdById          String
  assignedPhysicianId  String
  status               String   @default("DRAFT") // was enum PhysicianQueryStatus
  statusUpdatedAt      DateTime @default(now())
  draft                Boolean  @default(true)
  freeTextSupplement   String?
  sentAt               DateTime?
  respondedAt          DateTime?
  closedAt             DateTime?
  escalationLevel      Int      @default(0)
  slaDueAt             DateTime?
  closureReason        String?
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt
  responses            PhysicianQueryResponse[]
  auditEvents          PhysicianQueryAuditEvent[]
  evidence             EvidenceReference[]
  @@index([assignedPhysicianId, status])
  @@index([slaDueAt])
}

/// Physician query governance models adjusted: enums removed (string columns) and JSON fields serialized as NVARCHAR(MAX)
model PhysicianQueryResponse {
  id               String   @id @default(uuid())
  physicianQueryId String
  physicianQuery   PhysicianQuery @relation(fields: [physicianQueryId], references: [id])
  responderId      String
  responseType     String  // was enum PhysicianResponseType
  responseText     String?
  createdAt        DateTime @default(now())
}

model PhysicianQueryAuditEvent {
  id               String   @id @default(uuid())
  physicianQueryId String
  physicianQuery   PhysicianQuery @relation(fields: [physicianQueryId], references: [id])
  eventType        String   // was enum PhysicianQueryEventType
  actorUserId      String
  previousStatus   String?  // was PhysicianQueryStatus
  newStatus        String?  // was PhysicianQueryStatus
  metadata         String?  @db.NVarChar(Max) // was Json?
  sequence         Int
  hash             String
  prevHash         String?
  createdAt        DateTime @default(now())
  @@index([physicianQueryId, sequence])
}

model EvidenceReference {
  id               String   @id @default(uuid())
  physicianQueryId String
  physicianQuery   PhysicianQuery @relation(fields: [physicianQueryId], references: [id])
  sourceType       String  // was enum EvidenceSourceType
  sourceId         String?
  hash             String
  locator          String?
  snippet          String?
  metadata         String? @db.NVarChar(Max) // was Json?
  createdAt        DateTime @default(now())
  @@index([physicianQueryId])
}

model EobAdjudication {
  id        String   @id @default(uuid())
  eobLineId String
  category  String?
  amount    Decimal? @db.Decimal(12, 2)
  carc      String?
  rarc      String?
  reasonTxt String?
  eobLine   EobLine  @relation(fields: [eobLineId], references: [id])
  @@map("fact_eob_adj")
  @@index([carc, rarc])
}
